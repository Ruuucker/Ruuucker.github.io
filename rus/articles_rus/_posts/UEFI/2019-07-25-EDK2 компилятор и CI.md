---
title: Информация компилятора EDK2 и проблемы CI
layout: post
tags:
  - uefi_rus
published: true
---

# Оглавление
{:.no_toc}

* toc
{:toc}

# Цель

На этой странице будут обсуждаться расположение флагов компилятора в среде сборки TianoCore EDK2 (UDK 2014) и проблемы CI, которые необходимо учитывать при создании двоичных файлов EFI.

Если среда для этого не создана, вот страница которая обсуждает как это сделать (для Linux) здесь: [Настройка среды Linux для сборки EFI]({{ site.baseurl }}/rus/articles_rus/Настройка-среды-Linux-для-сборки-EFI/ "Настройка среды Linux для сборки EFI").


# Флаги компилятора

Наборы флагов компилятора которые будут использоваться сценарием сборки по умолчанию хранятся в ~/src/edk2/Conf/tools_def.txt. В этом документе ты можешь найти специфичные флаги для компилятора который ты используешь.

Эти флаги меняются в зависимости от того, какой компилятор и какая версия этого компилятора используются.

Проходя по файлу можно увидеть, что он сначала определяет пути к каждому из используемых компиляторов, а затем переходит к используемым флагам компилятора. Компилятор будет искать значение TOOL_CHAIN_TAG которое ты установил в target.txt, чтобы сообщить ему какой компилятор ты используешь.

Предположительно, ты можешь добавить поддержку EDK в новый компилятор (например: новую версию GCC или VS), определив его в tools_def.txt, а затем установив его в качестве целевой архитектуры в target.txt

Общая структура набора флагов компилятора: <Target_Toolchain_Arch_CommandType_Attribute>
Некоторые из этих значений могут быть опущены при необходимости.

Например, флаги которые будут использоваться для 64-битных приложений скомпилированных с помощью цепочки инструментов GCC 4.9 определены в GCC49_X64_CC_FLAGS, тогда как флаги для использования в общих компиляциях GCC находятся в GCC_ALL_CC_FLAGS.

# CI Проблема - Пути к файлам в двоичных файлах

Ниже приведен фрагмент вывода команды strings, запущенной в двоичном файле HelloWorld.efi, созданном в [Настройка среды Linux для сборки EFI]({{ site.baseurl }}/rus/articles_rus/Настройка-среды-Linux-для-сборки-EFI/ "Настройка среды Linux для сборки EFI") туториале по EFI.

~~~
$ strings -a HelloWorld.efi
[...]
/home/User/src/edk2/MdePkg/Library/BasePrintLib/PrintLibInternal.c
Width < 38
(Flags & ~(0x01 | 0x08 | 0x20 | 0x80)) == 0
((Flags & 0x08) == 0) || ((Flags & 0x80) == 0)
StrSize ((CHAR16 *) Format) != 0
AsciiStrSize (Format) != 0
<null string>
<null guid>
%08x-%04x-%04x-%02x%02x-%02x%02x%02x%02x%02x%02x
<null time>
%02d/%02d/%04d  %02d:%02d
%08X
(((Flags & 0x00000040) == 0)) || (StrSize ((CHAR16 *) OriginalBuffer) != 0)
(((Flags & 0x00000040) != 0)) || (AsciiStrSize (OriginalBuffer) != 0)
Divisor != 0
/home/User/src/edk2/MdePkg/Library/BaseLib/DivU64x32Remainder.c
NB10
/home/User/src/edk2/Build/DuetPkgX64/DEBUG_GCC49/X64/HelloWorld/HelloWorld/DEBUG/HelloWorld.dll
[...]
~~~

One of the first things you may notice is that absolute file paths are included in these binaries. For obvious reasons, this is something you need to be aware of, as your username, the package name, and the binary name are included in the binary.
Первое, что вы можете заметить, это то, что в эти двоичные файлы включены абсолютные пути к файлам. По понятным причинам, это то, что вам нужно знать, так как ваше имя пользователя, имя пакета и двоичное имя включены в двоичный файл.

Furthermore, these strings cannot (so far, with my experimentation) be stripped out of the binary using compiler flags. If you change the GCC compiler flags from -g to -s, the strings remain. If you change the objcopy flags to include --strip-all, the binary will hang when you run it.

However, you can manually NULL out the bytes that should have stored the path string (or use a python script to do it.) Unlike what I previously believed, if you simply NULL out the buffer where the string would have been stored, the program will execute normally. I would presume that you can put random junk there too and it will work.

I have yet to determine why these strings are included, but for now, be sure that when you are building EFI executables, you are careful with your built names and user name, or make sure to NULL out those strings.
