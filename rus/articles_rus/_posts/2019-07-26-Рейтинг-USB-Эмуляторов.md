---
title: Оценка Эмуляций USB
layout: post
tags:
  - articles_rus
  - windows
published: true
---
# Оглавление
{:.no_toc}

* toc
{:toc}


# BadUSB

BadUSB был темой для разговора на blackhat конференции о том, как USB устройства могут быть перепрограммированы чтобы стать вредоносным ПО. Основное внимание уделяется перезаписи оригинальной прошивки контроллера USB-устройства с помощью кастомной прошивки. Контроллер устройства USB действует как интерфейс между хостом и устройством USB. Кастомизация прошивки на контроллере USB-устройства предлагает множество возможностей. Управляя контроллером устройства USB, пользователь (человек, программирующий прошивку) может выбирать как он/она хочет, чтобы устройство взаимодействовало с хостом. Части устройства USB могут быть скрыты, например, если это запоминающее устройство или эмуляция запоминающего устройства, части хранилища могут быть скрыты от хоста. Если все сделано правильно, хост не сможет узнать что на самом деле представляет собой устройство. Вы могли бы подделать прошивку так, чтобы, если хост попросит о ней, он получил бы прошивку которую устройство хочет чтобы он получил, а не прошивку которая на самом деле на устройстве.

Также было отмечено, что BadUSB может заразить другие USB устройства и перезаписать их прошивку. Эта часть для меня туманна, я не понимаю как именно одно USB устройство может перезаписать прошивку другого USB. Эта возможность может значительно расширить сферу применения BadUSB. Его можно использовать как вредоносное вредоносное ПО, которое заражает периферийные USB устройства на компьютере затрудняя его обнаружение и удаление.

Стоит обратить внимание на использование скрытых разделов запоминающего устройства в сочетании с USBRubberDucky для возможности ввода и вывода на хост. Скрытие различных функций от хоста очень полезно для устройства такого типа, а эмуляция клавиатуры может использоваться для управления компьютером без попаданий на радары.



# USBRubberDucky

USBRubberDucky - это эмулятор клавиатуры. Он посылает нажатия клавиш на хост, как если бы это был пользователь который печатал на клавиатуре. Устройство имеет те же возможности, что и клавиатура, и это хорошо, и плохо. Если клавиатура не может что-то сделать, то USBRubberDucky тоже не может этого сделать. Это позволяет автоматизировать процесс набора ключей, делая его быстрее и точнее, чем кто-либо печатает. Недостатком является то, что он автоматизирован, поэтому он не может реагировать как человек, если что-то пошло не так или произошло что-то неожиданное. Следует подчеркнуть, что, действуя как клавиатура, компьютер доверяет USB-устройству после его подключения, что позволяет устройству обходить антивирусные сканеры. Это может позволить вам напечатать исполняемый файл и затем запустить его.

USBRubberDucky is a keyboard emulator. It sends keystrokes to the host as if the device was a keyboard that someone was typing on. The device has the same capabilities as a keyboard which is both good and bad. If a keyboard cannot do something, then the USBRubberDucky cannot do it either. It does allow for the key typing process to be automated making it faster and more accurate than someone typing. The downside is that it is automated, so it cannot react like a human could if something went wrong or something unexpected occurred. A point to highlight is that by acting as a keyboard, the computer trusts the USB device once it is connected, allowing the device to bypass virus scanners. This can enable you to type out an executable and then run it.

The USBRubberDucky is well crafted both through its software and hardware. The software has a nice interface for users and comes with a good amount of documentation/examples online. The hardware comes with an SD card that can be removed, making it easy to add new payloads that will be automated upon connection to a target computer/device. There is also a button that reruns the device so that it could reexecute (retype in the case of keyboard emulation) the payload.

 

# Goodfet / Facedancer

The Facedancer21 has source code provided for various USB capabilities. The ones I have worked with are the keyboard and FTDI emulation. The firmware allows for many different clients to be developed in python. This requires a computer containing the client code to be connected the board, so that the client can be executed from the the host (controlling) computer passing information to the board of what to send to the target computer. Requiring a host computer to tell the board what to do isn't the best way idea of a final product to be used in the field but this could help with Proof of Concept work.

I further developed the keyboard and FTDI client to have more functionality. The keyboard client takes a format file on the host and sends the keystrokes to the target. Moving forward, I would suggest using the USBRubberDucky technology/code for keyboard emulation, because it has been developed much more than the facedancer-keyboard code.

Pros: The facedancer21 has the ability to run many different clients.

Cons: On the current setup, all the clients are in python and are made to interface with the board from the host. That makes it difficult to take the existing python client code and flash it on the board so that the client can be automated on connection to a target (not requiring a host computer to also be connected to the board). Therefore, for automation and not needing a host to be connected, the firmware will need to be changed.

Possibly look into being able to flash the firmware with totally different code so that the board can run one client by itself. Check how power is supplied to the board. The host USB connection supplies power to the board, and the target USB connection may or may not supply power to the board. Understanding how the board gets flashed with the firmware would be very helpful (knowing how to flash multiple files and being able to tweak the flashing process).

See the Facedancer21 UserGuide for more information.

 

# Future

From what I have seen and read, I see a good amount of potential from the BadUSB concept/technology. I think the ideal plan is to know exactly what we want our device to do first and build a board that is customized for its purposes. In reference to keyboard emulation alone, I think USBRubberDucky has a very good setup in regard to their board and software, as I have previously mentioned. If we want to add on to keyboard emulation, then I believe we should consider including the same capabilities and code that the USBRubberDucky uses (ease of changing payloads, possibly a button for rerun, and definitely the encoder/source code). A more general plan is to have a USB device much like a USB thumb drive that we can easily change the USB device controller firmware. Unlike the USBRubberDucky with its SD, the Facedancer21 does not have an offchip storage component. Having a storage component on the device would be preferred so that it could appear to be a normal USB thumb drive if it needs to.
