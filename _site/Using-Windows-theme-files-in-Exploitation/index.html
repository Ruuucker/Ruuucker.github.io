<!DOCTYPE html>
<html lang="en">
	
<!-- Basic information about this page -->
<meta charset="UTF-8">
<link rel="icon" type="image/x-icon" href="/assets/img/fav.ico">
<title>
	
		Using Windows Theme Files In Exploitation ::
	
	Rucker :: Security Researcher
</title>

<!-- Meta tag looking for mobile devices -->
<meta name="viewport" content="initial-scale=1.5">
<meta name="theme-color" content="#232323">

<!-- Good information about this page -->
<meta name="description" content="Security Researcher">
<meta name="keywords" content="Security, Hacking">
<meta name="author" content="Rucker">

<!-- Style and scripts files -->
<link rel="stylesheet" type="text/css" href="/assets/css/style.css">

<!-- Extra information about this page -->
<link rel="license" type="text/plain" src="/assets/LICENSE">

<!-- Facebook, Linkedin, Reddit and many others Open Graph -->
<meta property="og:site_name" content="Rucker" />
<meta property="og:title" content="Rucker :: Security Researcher" />
<meta property="og:type" content="website" />
<meta property="og:description" content="Security Researcher" />
<meta property="og:url" content="https://ruuucker.github.io" />
<meta property="og:image:type" content="image/png" /> <!-- less than 5mB -->
<meta property="og:image:width" content="600" />
<meta property="og:image:height" content="315" />
<meta property="og:image" content="/assets/img/cover.svg" />
<meta property="og:locale" content="en" />
<meta property="og:locale:alternate" content="ru_RU" />
<meta property="fb:page_id" content="688484114615664" />

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Rucker :: Security Researcher" />
<meta name="twitter:description" content="Security Researcher" />
<meta name="twitter:url" content="https://ruuucker.github.io" />
<meta name="twitter:image" content="/assets/img/cover.svg" />
<meta name="twitter:author" content="" />

<!-- Linkedin OGP cards -->
<meta property="og:image" content="/assets/img/cover.svg" />
<meta property="og:image:width" content="180" />
<meta property="og:image:height" content="110" />

<!-- Google+ OGP cards -->
<meta itemprop="name" content="Rucker :: Security Researcher" />
<meta itemprop="author" content="" />
<meta itemprop="description" content="Security Researcher" />
<meta itemprop="image" content="/assets/img/cover.svg" />


<script type="text/javascript">
	if (window.location.protocol != "https:")
		window.location.href = "https:" + window.location.href.substring(window.location.protocol.length);
</script>

	<body>
		<header>
	<pre class="ascii name">
      ___           ___           ___           ___           ___           ___     
     /\  \         /\__\         /\  \         /\__\         /\  \         /\  \    
    /::\  \       /:/  /        /::\  \       /:/  /        /::\  \       /::\  \   
   /:/\:\  \     /:/  /        /:/\:\  \     /:/__/        /:/\:\  \     /:/\:\  \  
  /::\~\:\  \   /:/  /  ___   /:/  \:\  \   /::\__\____   /::\~\:\  \   /::\~\:\  \ 
 /:/\:\ \:\__\ /:/__/  /\__\ /:/__/ \:\__\ /:/\:::::\__\ /:/\:\ \:\__\ /:/\:\ \:\__\
 \/_|::\/:/  / \:\  \ /:/  / \:\  \  \/__/ \/_|:|~~|~    \:\~\:\ \/__/ \/_|::\/:/  /
    |:|::/  /   \:\  /:/  /   \:\  \          |:|  |      \:\ \:\__\      |:|::/  / 
    |:|\/__/     \:\/:/  /     \:\  \         |:|  |       \:\ \/__/      |:|\/__/  
    |:|  |        \::/  /       \:\__\        |:|  |        \:\__\        |:|  |    
     \|__|         \/__/         \/__/         \|__|         \/__/         \|__|    
       
</pre>
</header>

      	
      		<nav>
	<ul>
	<li><a href="/#">Home</a></li>
      	<li><a href="/#articles">Articles</a></li>
	<!-- <li><a href="/#methods">Methodolodys</a></li> --!>
		<li><a href="/#cheatsheets">Cheat Sheets</a></li>
      	<li><a href="/#tools">Tools</a></li>
      	<li><a href="/#contact">Contact</a></li>
	<li><a href="/ru/">Rus</a></li>
	</ul>
</nav>

		
		<main>
			<br>
<header>
	<h1>Using Windows Theme Files In Exploitation</h1>
</header>

<h1 class="no_toc" id="summary">Summary</h1>

<ul id="markdown-toc">
  <li><a href="#general" id="markdown-toc-general">General</a></li>
  <li><a href="#examples" id="markdown-toc-examples">Examples</a></li>
  <li><a href="#interesting-theme-file-characteristics" id="markdown-toc-interesting-theme-file-characteristics">Interesting Theme File Characteristics</a></li>
</ul>

<h1 id="general">General</h1>
<p>Theme files (.theme) are intended for modifying the way your machine looks. Theme files are of the ini/inf format where the file is a list of sections and properties. For example, there is a theme section that you can use in a theme file. In the theme section you can set a display name for the theme as well as a logon background. An example theme section looks like this:</p>

<p><br /><br /></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Theme]

; Windows 7 - IDS_THEME_DISPLAYNAME_AERO - Comments start with semicolons

DisplayName=@%SystemRoot%\System32\themeui.dll,-2013

SetLogonBackground=0
</code></pre></div></div>

<h1 id="examples">Examples</h1>

<p>The list of things you can set with a theme file is extensive. Here is an example theme file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>; Copyright © Microsoft Corp.

[Theme]
; Windows 7 - IDS_THEME_DISPLAYNAME_AERO
;DisplayName=@%SystemRoot%\System32\themeui.dll,-2013
DisplayName=@%SystemRoot%\System32\test.dll,-2013
SetLogonBackground=0

; Computer - SHIDI_SERVER
[CLSID\{20D04FE0-3AEA-1069-A2D8-08002B30309D}\DefaultIcon]
DefaultValue=%SystemRoot%\System32\imageres.dll,-109

; UsersFiles - SHIDI_USERFILES
[CLSID\{59031A47-3F72-44A7-89C5-5595FE6B30EE}\DefaultIcon]
DefaultValue=%SystemRoot%\System32\imageres.dll,-123

; Network - SHIDI_MYNETWORK
[CLSID\{F02C1A0D-BE21-4350-88B0-7367FC96EF3C}\DefaultIcon]
DefaultValue=%SystemRoot%\System32\imageres.dll,-25

; Recycle Bin - SHIDI_RECYCLERFULL SHIDI_RECYCLER
[CLSID\{645FF040-5081-101B-9F08-00AA002F954E}\DefaultIcon]
Full=%SystemRoot%\System32\imageres.dll,-54
Empty=%SystemRoot%\System32\imageres.dll,-55

[Control Panel\Cursors]
AppStarting=%SystemRoot%\cursors\aero_working.ani
Arrow=%SystemRoot%\cursors\aero_arrow.cur
Crosshair=
Hand=%SystemRoot%\cursors\aero_link.cur
Help=%SystemRoot%\cursors\aero_helpsel.cur
IBeam=
No=%SystemRoot%\cursors\aero_unavail.cur
NWPen=%SystemRoot%\cursors\aero_pen.cur
SizeAll=%SystemRoot%\cursors\aero_move.cur
SizeNESW=%SystemRoot%\cursors\aero_nesw.cur
SizeNS=%SystemRoot%\cursors\aero_ns.cur
SizeNWSE=%SystemRoot%\cursors\aero_nwse.cur
SizeWE=%SystemRoot%\cursors\aero_ew.cur
UpArrow=%SystemRoot%\cursors\aero_up.cur
Wait=%SystemRoot%\cursors\aero_busy.ani
DefaultValue=Windows Aero
DefaultValue.MUI=@main.cpl,-1020

[Control Panel\Desktop]
Wallpaper=%SystemRoot%\web\wallpaper\Windows\img0.jpg
TileWallpaper=0
WallpaperStyle=10
Pattern=

[VisualStyles]
Path=%ResourceDir%\Themes\Aero\mytheme.msstyles
ColorStyle=NormalColor
Size=NormalSize
ColorizationColor=0x6B74B8FC
Transparency=1

[boot]
SCRNSAVE.EXE=

[MasterThemeSelector]
MTSM=DABJDKT

[Sounds]
; IDS_SCHEME_DEFAULT
SchemeName=@%SystemRoot%\System32\mmres.dll,-800
</code></pre></div></div>

<p>One of the interesting sections in the theme file is [Slideshow]. The slideshow portion of the theme allows you to select files that are used in the icon of the theme file. It is used for other things, but the most interesting portion is that the first three of the list are used as the icons of the theme file. So in the cases where your execution vector uses icon rendering/file previews to exploit (link files, font files), a theme file can allow you to point to up to three other files and render them from one.</p>

<p>Take the example of having three fonts. There are three fonts because one will only exploit Windows 7 x86, another exploits Windows 7 x64, the third exploits Windows XP x86. To get full coverage normally, you would put all three font files in a directory. When the target navigates to the directory containing the font files, execution is gained. Now, let say you have another of the microsoft “interesting” files, like a desktop.ini or a library-ms. You could use other files to specify that your “theme” file should be the icon for something. For this example, let’s say that we make it the icon of something in the root of the drive.  We’ll put the fonts system, hidden and buried on the drive. When the target goes to the root of the drive and the icon is rendered, the theme file is rendered. The theme file then has the relative paths to the font files on the system and renders all three fonts. Thus, you have moved from needing three exploits in the directory a target is navigating to, to hidden files while maintaining the same coverage.</p>

<p>Here’s an example of a modified theme file that would render 3 fonts upon the rendering of itself.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Slideshow]

Interval=1800000

Shuffle=1

ImagesRootPath=MyFolder\temp

Item0Path=MyFolder\temp\font1.fon

Item1Path=MyFolder\temp\font2.fon

Item2Path=MyFolder\temp\font3.fon
</code></pre></div></div>

<h1 id="interesting-theme-file-characteristics">Interesting Theme File Characteristics</h1>

<p>Another note made from playing with Microsoft theme files. Calling ShellExecute on a theme file will cause the theme to be changed to the default. This does cause the opening of a Control Panel window if you don’t hide it.</p>


		</main>
	</body>
</html>
