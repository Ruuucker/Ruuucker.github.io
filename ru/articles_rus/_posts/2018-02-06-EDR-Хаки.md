---
layout: post
categories: articles
tags:
  - ru
  - edr
published: true
ru: true
---

# Оглавление
{:.no_toc}

* toc
{:toc}

# Рекон
Первым делом определяем есть ли на точке EDR, в этом помогает:

1) Листинг процессов, тут всё понятно
2) Брать цифровую подпись драйверов ядра и сравнение оных с известными сигнатурами вендоров, вот тулза для таких вещей [https://gist.github.com/jthuraisamy/4c4c751df09f83d3620013f5d370d3b9]

Так же при приземлении на точке нужно не только понять что за EDR тут запущена, но и как она сконфигурирована, для этого нужно искать конфиг путь к которому обычно есть в документации к этому продукту, так же нужно оттуда почерпнуть как разшифровать его, если он зашифрован.

# Разбираемся с потоком телеметрии

Общие вопросы на которые стоит ответить прежде чем предпринимать действия.
1) Кэшируется ли телеметрия на диск или в память?
2) Если это на диске, это может быть БД, файл временного кэша или «безфайловый»?
3) Если в памяти, насколько возможно извлечь из неё всё и написать фиктивный сервер?
4) Предлагает ли продукт диагностический механизм для запроса телеметрии?
5) Нужно ли расшифровывать или деобфусировать буферы перед десериализацией?
6) Как они сериализуются (например, ProtoBuf, JSON, Bond, custom)?
7) Доступны ли схемы для типов событий? Если нет, можно ли их восстановить?

Обычно бывают 2 сценария
1) Телеметрия записывается где-то в долгой памяти ПК либо кешируется и сервер забирает данные в интервале, либо хранится в оперативке
  В этом случае можно попробовать получить доступ к этим данным, возможно их метоположение будет в документации и возможно они будут защифрованны, а еще сама EDR может тригернуться на попытку получить доступ к данным не из положенного процесса, так что это опасный путь с минами.
  После получения этих данных их предстоит распарсить, либо это будут ProtoBuf [https://developers.google.com/protocol-buffers] с тулзой [https://github.com/mildsunrise/protobuf-inspector] или JSON.
  Так же схемы восстановления данных могут быть найдены онлайн [https://github.com/carbonblack/cbapi/blob/master/server_apis/proto/sensor_events.proto], либо сделать вот так (я не понял как) [http://jackson-t.ca/protobuf-recovery.html], либо в документашке либо вот в проекте OSSEM [https://github.com/hunters-forge/OSSEM/tree/master/data_dictionaries/windows]. Но чет тут я теряюсь и не могу кристально чисто ответить на многие вопросы.
  После сохранения файла за ним приходит сервер и после ответа 200 файл удаляется. Но его дескриптор всё еще доступен и может быть вытащен [https://github.com/marin-m/pbtk] если это протобаф.

2) Телеметрия идет непрерывным потоком на сервер с помощью Веб сокетов.
Если можно изменить хоть что нибудь через конфиг касающегося сокетов, стоит попробовать. В зависимости от этого можно либо пробовать отключить шифр\сменить удаленный сервер\что нибудь похожее либо пробовать ставить прокси, смотреть на трафик и скорее всего забивать, потому что там TSL. Тут очень много зависит от конфига, потому что в теории мы можем поставить на точку заглушку для сервера, но вот настоящий клиент не угомонится если мы не направим его праведный гнев в другое русло.

# Ссылки
Попытка [запустить](https://forensicitguy.github.io/posts/linux-edr-evasion-with-ld-preload/) meterpreter в обход EDR
Такие вещи как DLL hijacking с помощью [Sys Whispers](https://github.com/jthuraisamy/SysWhispers) что на самом деле опять же реализация прямых сисколов.
Дампы памяти в обход EDR/AV с помощью "прямых" Win32API которые недокументированно находятся за документированным слоем [sdf](https://outflank.nl/blog/2019/06/19/red-team-tactics-combining-direct-system-calls-and-srdi-to-bypass-av-edr/) и так же хорошая [ссылка](https://github.com/outflanknl/Dumpert) на тулзу реализующую подобный подход [Обход AV/EDR при запуске офис макросов с помощью VBScript который оказывается имеет возможность менять родительский процесс от которого он спавнится, делать запранированые таски и даже сука ключи регистра менять. Чет я сомневаюсь что это это возможно от имени обычного юзера.](https://blog.f-secure.com/dechaining-macros-and-evading-edr/).

[Возможно это обманет EDR](https://github.com/ionescu007/faxhell).

EDR как я понял плохо работает с макросами екселя, поэтому можно попробовать выполнить шелл через [него](https://www.mdsec.co.uk/2019/03/silencing-cylance-a-case-study-in-modern-edrs/) и [него](https://outflank.nl/blog/2018/10/06/old-school-evil-excel-4-0-macros-xlm/)

[Дампит lsass в обход Cylance, может сработать и с другими](https://github.com/hoangprod/AndrewSpecial/tree/master).

[Очередной PoC для анти-юзерленд-хукинг](https://github.com/NtRaiseHardError/Antimalware-Research/tree/master/Generic/Userland%20Hooking/AntiHook).






