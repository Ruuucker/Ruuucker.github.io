---
title: Компиляторы в связке с EDK2 и проблемы CI
layout: post
tags:
  - uefi
published: true
ru: true
---

# Оглавление
{:.no_toc}

* toc
{:toc}

# Цель

На этой странице будут обсуждаться расположение флагов компиляторов в среде сборки TianoCore EDK2 (UDK 2014) и проблемы CI, которые необходимо учитывать при создании двоичных файлов EFI.

Если среда для этого не создана, вот страница которая обсуждает как это сделать (для Linux) здесь: [Настройка среды Linux для сборки EFI]({{ site.baseurl }}/rus/articles_rus/Настройка-среды-Linux-для-сборки-EFI/ "Настройка среды Linux для сборки EFI").


# Флаги компилятора

Наборы флагов для любого компилятора, которые будут использоваться сценарием сборки, по умолчанию хранятся в ~/src/edk2/Conf/tools_def.txt. В этой статье ты можешь найти специфичные флаги для компилятора который ты используешь.

Эти флаги меняются в зависимости от того, какой компилятор и какая его версия используются.

Проходя по файлу можно увидеть, что он сначала определяет пути к каждому из используемых компиляторов, а затем переходит к используемым флагам компилятора. EDK будет искать значение TOOL_CHAIN_TAG которое ты установил в target.txt, чтобы сообщить ему какой компилятор ты используешь.

Предположительно, ты можешь добавить поддержку EDK в новый компилятор (например: новую версию GCC или VS), определив его в tools_def.txt, а затем установив его в качестве целевой архитектуры в target.txt

Общая структура набора флагов компилятора: <Target_Toolchain_Arch_CommandType_Attribute>
Некоторые из этих значений могут быть опущены при необходимости.

Например, флаги которые будут использоваться для 64-битных приложений скомпилированных с помощью цепочки инструментов GCC 4.9 определены в GCC49_X64_CC_FLAGS, тогда как флаги для использования в общих компиляциях GCC находятся в GCC_ALL_CC_FLAGS.

# CI Проблема - Пути к файлам в двоичных файлах

Ниже приведен фрагмент вывода команды strings, запущенной в двоичном файле HelloWorld.efi, созданном в [Настройка среды Linux для сборки EFI]({{ site.baseurl }}/rus/articles_rus/Настройка-среды-Linux-для-сборки-EFI/ "Настройка среды Linux для сборки EFI") туториале по EFI.

~~~
$ strings -a HelloWorld.efi
[...]
/home/User/src/edk2/MdePkg/Library/BasePrintLib/PrintLibInternal.c
Width < 38
(Flags & ~(0x01 | 0x08 | 0x20 | 0x80)) == 0
((Flags & 0x08) == 0) || ((Flags & 0x80) == 0)
StrSize ((CHAR16 *) Format) != 0
AsciiStrSize (Format) != 0
<null string>
<null guid>
%08x-%04x-%04x-%02x%02x-%02x%02x%02x%02x%02x%02x
<null time>
%02d/%02d/%04d  %02d:%02d
%08X
(((Flags & 0x00000040) == 0)) || (StrSize ((CHAR16 *) OriginalBuffer) != 0)
(((Flags & 0x00000040) != 0)) || (AsciiStrSize (OriginalBuffer) != 0)
Divisor != 0
/home/User/src/edk2/MdePkg/Library/BaseLib/DivU64x32Remainder.c
NB10
/home/User/src/edk2/Build/DuetPkgX64/DEBUG_GCC49/X64/HelloWorld/HelloWorld/DEBUG/HelloWorld.dll
[...]
~~~

Первое что можно заметить, это то что в эти двоичные файлы включены абсолютные пути к исходникам. По понятным причинам это то о чем нужно быть соведомленным, так как ваше имя пользователя, имя пакета и двоичное имя включены в бинарник.

Кроме того, эти строки нельзя (по моим экспериментам) удалить из двоичного файла с помощью флагов компилятора. Если вы измените флаги компилятора GCC с -g на -s, строки останутся. Если вы измените флаги objcopy для включения --strip-all, двоичный файл будет зависать при его запуске.

Тем не менее, вы можете вручную обнулять байты в которых должна храниться строка пути (или использовать скрипты для этого). Неожиданно для меня, если просто обнулять буфер в котором будет храниться строка, программа будет работать нормально. Похоже что даже есл положить туда случайный мусор то она будет работать. Такие дела.
